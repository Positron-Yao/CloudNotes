# ffmpeg学习

[TOC]

### 剪辑视频

```powershell
ffmpeg -ss [开始时间] -to [截止时间] -i [输入文件] -codec copy [out].mp4
```

---

### 调整码率

```powershell
ffmpeg -i [输入文件] -b:v [...] [out].mp4
```
大概到6000k还能看，再低了就看不了力（）

---

### 合并视频

先新建一个`cat.txt`文件：
```Text
file 'part_1.mp4'
file 'part_2.mp4'
file 'part_3.mp4'
```
命令：
```powershell
ffmpeg -f concat -i cat.txt -codec copy [out].mp4
```

---

### 导出帧

```powershell
ffmpeg -i [输入文件] -f image2 -r [fps] [image_%03d.png]
```

`-f image2`：指定输出格式

`[Fimage_%03d.png]`：格式化输出

---

### 倍速&慢速

将30fps的视频4倍速播放（即120fps）

```powershell
ffmpeg -i input.mkv -r 120 -filter:v "setpts=0.25*PTS" output.mkv
```

音频倍速

atempo filter 配置区间在0.5和2.0之间，如果需要更高倍，可以使用多个 atempo filter 串在一起来实现，下面是实现4倍的参考

```powershell
ffmpeg -i input.mkv -filter:"atempo=2.0,atempo=2.0" -vn output.mkv
```

同时修改

```powershell
ffmpeg -i input.mkv -filter_complex "[0:v]setpts=0.5*PTS[v];[0:a]atempo=2.0[a]" -map "[v]" -map "[a]" output.mkv
```

---

### 倒放

```powershell
ffmpeg -i [input.mp4] -vf reverse -af areverse [out.mp4]
```

---

### 循环视频

```powershell
ffmpeg -stream_loop [loop_count] -i [input.mp4] -c copy [out.mp4]
```

---

### 混流

```powershell
ffmpeg -i [video_only.mp4] -i [audio_only.mp4] -c:v copy -c:a aac -strict experimental [out.mp4]
```

> B站下载视频，也是用这个方法混流

---

### 添加字幕

玛雅ArcTime也太好用了罢，打字幕像音游

> .srt: 纯文本文件，其中包含字幕文本和每句字幕的起止时间
>
> - 一般格式:
>
> - ```srt
>   1	// 序号
>   00:00:01,675 --> 00:00:04,375	//起止时间
>   现在是6月13号	// 字幕内容
>   	// 一行空白
>   ```
>
> - .srt文件中不包含字幕文本的样式
>
> .ass: 纯文本文件，包含[Script Info] [V4+ Styles] [Events]三部分
>
> - 一般格式:
>
> - ```ass
>   [Script Info]
>   ; Script generated by FFmpeg/Lavc60.18.100
>   ScriptType: v4.00+
>   PlayResX: 384
>   PlayResY: 288
>   ScaledBorderAndShadow: yes
>   YCbCr Matrix: None
>                                   
>   [V4+ Styles]
>   Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
>   Style: Default,微软雅黑,50,&H00FFFBDB,&H000000FF,&H9E000000,&H66383726,0,0,0,0,100.0,100.0,0.0,0.0,1,1.1153846,1.0,2,0,0,50,1
>                                   
>   [Events]
>   Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
>   Dialogue: 0,0:00:01.68,0:00:04.38,Default,,0,0,0,,现在是6月13号
>   Dialogue: 0,0:00:05.18,0:00:07.83,Default,,0,0,0,,晚上的8:36
>   ```
>
> - Style部分可以在Arctime中复制文本样式得到

使用Arctime制作字幕后，导出.srt字幕文件

使用`ffmpeg -i [*.srt] [out.ass]`可以将.srt文件转为.ass，之后手动加入Style部分即可

#### 硬字幕

```powershell
ffmpeg -i [*.mp4] -vf subtitles=[*.srt] [out.mp4]	::添加简单的.srt字幕
ffmpeg -i [*.mp4] -vf ass=[*.ass] [out.mp4]		::添加.ass字幕
```

#### 软字幕

```powershell
ffmpeg -i [*.mp4] -i [*.srt / *.ass] -c copy -c:s mov_text -metadata:s:s:0 language=chi [out.mp4]
```

多通道(软)字幕

```powershell
ffmpeg -i [*.mp4] -i [ch.srt] -i [en.srt] -map 0 -map 1 -map 2 -c copy -c:s mov_text -metadata:s:s:0 language=chi -metadata:s:s:1 language=eng [out.mp4]
```

---

### 裁剪视频尺寸

```powershell
ffmpeg -i [input.mp4] -vf crop=w=[]:h=[]:x=[]:y=[] [out.mp4]
```

其中`(x, y)`是屏幕矩形的左上角坐标，(w, h)是新的尺寸。屏幕坐标系取左上角为坐标原点。

---

### 音视频倍速

视频倍速:两倍速

```powershell
ffmpeg -i test.mp4 -filter：v "setpts=0.5*PTS" test-0.5.mp4
```
视频速度调整取决于setpts视频滤波器的数值，支持的范围是0.25-4，数值越大，速度越快，两倍速是0.5，四倍速是0.25，以此类推

音频倍速:两倍速

```powershell
ffmpeg -i test.mp4 -filter：a  "atempo=2.0" -vn test-2.mp4
```

由于atempo只支持0.5到2.0的数值，如果想要调整只四倍速，可以填写两组atempo

```powershell
ffmpeg -i test.mp4 -filter：a  "atempo=2.0,atempo=2.0" -vn test-2.mp4
```

视频音频同时调整

```powershell
ffmpeg -i test.mp4 -filter_complex "[0:v]setpts=0.5*PTS[v];[0:a]atempo=2.0[a]" -map "[v]" -map "[a]" test-2.mp4
```

---

### m3u8下载

没太懂其实（）

用浏览器插件获取到视频和音频的.ts文件

```powershell
ffmpeg -i ***.ts -c copy output.mp4
```

然后合并音频视频

```powershell
ffmpeg -i 1.mp4 -i 2.mp4 -c:v copy -c:a copy out.mp4
```

---

### 屏幕捕获

神人小功能()还挺好用的

```powershell
ffmpeg -f gdigrab -i desktop -r 30 -b:v 8M -minrate 6M -maxrate 10M -bufsize 8M -y E:/Videos/tmp.mp4
```

